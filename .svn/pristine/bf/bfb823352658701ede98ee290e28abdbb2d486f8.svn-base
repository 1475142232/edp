KISSY.add("myself-module/src/myself",function(S,IO,Calendar,Cookie){
	function Myself(){
		var _this = this;
		var cookie = new Cookie();
		
		this.init = function(){
			_this.getUserInfo();//获取用户信息
			_this.getUserTask();//获取用户下的任务
			_this.addProblemValidator();//设置新增问题的校验
		};
		
		/*
		 * 获取用户的个人信息
		 */
		this.getUserInfo = function(){
			$.ajax({
	             type: "post",
	             url: "userController/getUser.action",
	             dataType: "json",
	             success: function(data){
	            	 if(data !== null){
	            		 $("#info_UserId").text(data.id);
	            		 $("#info_UserName").text(data.userName);
	            		 $("#info_UserMail").text(data.userMail);
	            	 }else{
	            		 $('#modelInfo').text("查询失败，请联系管理员!");
	            		 $('#myModal').modal('show');
	            	 }
	             },
	             error: function(errorTwon){
	            	 
	             }
	        });
			
			//跳转到自己的项目日历
			$("#CalendarId").on("click",function(){
				IO.get("views/fullcalendar/agenda-views.html",null,function(){
	     			$("#mainpage").html(arguments[0], true);
                    var calendar = new Calendar();
                    calendar.init();
	         	});
			});
			
			//新增问题弹框
			$("#addProblem").on("click", function(){
				var productId =  $('.task-dateil-task input[name="task"]:checked').attr("productId");
				if(productId !== undefined && productId !== ""){
					//清除表单验证信息
					$("#addProblem_Form").data('bootstrapValidator').destroy();
					$('#addProblem_Form').data('bootstrapValidator', null);
					_this.addProblemValidator();
					
					//清空表单
					$("#problemName").val("");
					$("#problemDesc").val("");
					$("#productId").val(productId);
					
					$("#error").html("");
					
					_this.getProjectUserList();//获取团队或项目下的所有用户
					$("#addProblemModal").modal('show');
				}else{
					$("#myModal").modal("show");
					$("#modelInfo").text("请选择一个任务！");
				}
			});
			
			//提交任务弹框提示
			$("#submitProblem").on("click", function(){
				var id =  $('.task-dateil-task input[name="task"]:checked').attr("id");
				if(id !== undefined && id !== ""){
					_submitProblem(id);
				}else{
					$("#myModal").modal("show");
					$("#modelInfo").text("请选择一个任务！");
				}
			});
			
			//提交问题
			$("#save_Problem").on("click", function(){
				 $('#addProblem_Form').bootstrapValidator('validate');
	        	 if($('#addProblem_Form').data('bootstrapValidator').isValid()){
        		    _this.addProblemInfo();
	        	 }
			});
			
			$("#problemEndUser").on("click", function(){
				if($(this).val() === ""){
					$("#problemEndName").val("");
				}else{
					$("#problemEndName").val($(this).find("option:selected").text());
				}
			});
		};
		
		/*
		 * 获取用户所有任务
		 */
		this.getUserTask = function(){
			$("#noList").html('');
			$("#yesList").html('');
			$("#approveList").html('');
			$.ajax({
	             type: "post",
	             url: "TaskInfoController/findTaskInfoByUserId.action",
	             dataType: "json",
	             success: function(data){
	            	 if(data !== null && data.length > 0){
	            		 //未完成的任务
	            		 if(data[0] !== null && data[0].length > 0){
	            			 var data1 = data[0];
	            			 var taskHtml = "";
	            			 for (var i = 0; i < data1.length; i++) {
	            				 taskHtml += '<div class="task-list-info">'
	            					 +'<div class="task-list-info-name">'
	            					 +'<input type="radio" name="task" style="float:left;" id="'+ data1[i].id +'" />'
	            					 +'<span class="info-taskname">'+ data1[i].taskName +'</span>'
	            					 +'<span class="info-tasktime">交付时间：</span>'
	            					 +'<span class="info-tasktime">'+ data1[i].taskDoneTime +'</span>'
	            					 +'</div>'
	            					 +'<div class="task-list-info-desc">'
	            					 + data1[i].taskSpec
	            					 +'</div>'
	            					 +'</div>';
							}
	            			$("#noList").append(taskHtml);
	            			//统计未完成的任务
	            			$("no_task").text(data[0].length);
	            		}else{
	            			$("#noList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		}
	            		//已完成的任务
	            		if(data[1] !== null && data[1].length > 0){
	            			var data2 = data[1];
	            			 var taskHtml = "";
	            			 for (var i = 0; i < data1.length; i++) {
	            				 taskHtml += '<div class="task-list-info">'
	            					 +'<div class="task-list-info-name">'
	            					 +'<input type="radio" name="task" style="float:left;" id="'+ data2[i].id +'" productId="'+data2[i].productId+'"/>'
	            					 +'<span class="info-taskname">'+ data2[i].taskName +'</span>'
	            					 +'<span class="info-tasktime">交付时间：</span>'
	            					 +'<span class="info-tasktime">'+ data2[i].taskDoneTime +'</span>'
	            					 +'</div>'
	            					 +'<div class="task-list-info-desc">'
	            					 + data2[i].taskSpec
	            					 +'</div>'
	            					 +'</div>';
							}
	            			$("#yesList").html(taskHtml);
	            			//统计已完成的任务
	            			$("yes_task").text(data[1].length);
	            		}else{
	            			$("#yesList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		}
	            		//审核的任务
	            		if(data[2] !== null && data[2].length > 0){
	            			 var data3 = data[2];
	            			 var taskHtml = "";
	            			 for (var i = 0; i < data1.length; i++) {
	            				 taskHtml += '<div class="task-list-info">'
	            					 +'<div class="task-list-info-name">'
	            					 +'<input type="radio" name="task" style="float:left;" id="'+ data3[i].id +'" />'
	            					 +'<span class="info-taskname">'+ data3[i].taskName +'</span>'
	            					 +'<span class="info-tasktime">交付时间：</span>'
	            					 +'<span class="info-tasktime">'+ data3[i].taskDoneTime +'</span>'
	            					 +'</div>'
	            					 +'<div class="task-list-info-desc">'
	            					 + data3[i].taskSpec
	            					 +'</div>'
	            					 +'</div>';
							}
	            			$("#approveList").html(taskHtml);
	            			//统计审核的任务
	            			$("approve_task").text(data[2].length);
	            		}else{
	            			$("#approveList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		}
	            	 }else{
	            		 $("#noList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		 $("#yesList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		 $("#approveList").html('<div class="task-list-info">暂无相关任务。<div>');
	            		 $('#modelInfo').text("查询失败，请联系管理员!");
	            		 $('#myModal').modal('show');
	            	 }
	             },
	             error: function(errorTwon){
	            	 
	             }
	        });
		};
		
		/**
		 * 设置新增问题的校验
		 */
		this.addProblemValidator = function(){
			$('#addProblem_Form').bootstrapValidator({
	            message: 'This value is not valid',
	            feedbackIcons: {
	                valid: 'glyphicon glyphicon-ok',
	                invalid: 'glyphicon glyphicon-remove',
	                validating: 'glyphicon glyphicon-refresh'
	            },
	            fields: {
	            	problemName: {
	                    message: 'The username is not valid',
	                    validators: {
	                        notEmpty: {
	                            message: '请输入问题名称!'
	                        },
	                        stringLength: {
	                            max: 20,
	                            message: '长度最大不能超过20!'
	                        },
	                        regexp: {
	                            regexp: /^[a-zA-Z0-9\u2E80-\u9FFF\.\_\-]+$/,
	                            message: '输入的名字格式错误!(只能输入汉字、字母、数字、.、_、-)'
	                        }
	                    }
	                },
	                problemDesc: {
	                    validators: {
	                    	notEmpty: {
	                            message: '请输入问题描述!'
		                    },stringLength: {
	                            max: 50,
	                            message: '长度最大不能超过500!'
	                        }
	                    }
	                },
	                problemType: {
	                	validators: {
	                		notEmpty: {
	                            message: '请选择问题类型!'
	                        }
	                    }
	                },
	                problemLv: {
	                	validators: {
	                		notEmpty: {
	                            message: '请选择问题等级!'
	                        }
	                    }
	                },
	                problemEndUser: {
	                	validators: {
	                		notEmpty: {
	                            message: '请选择问题解决人!'
	                        }
	                    }
	                }
	            }
	        });
		};
		
		/**
		 * 获取团队或项目下的所有用户
		 */
		this.getProjectUserList = function(){
			$("#problemEndUser").html("");
			$("#problemEndName").val("");
			var teamId = cookie.getCookie("teamId");
			var productId =  $('.task-dateil-task input[name="task"]:checked').attr("productId");
			var url = "userController/findUserByproductId.action?teamId="+ teamId +"&productId="+ productId;
			$.ajax({
	             type: "POST",
	             url: url,
	             async: true,
	             dataType: "json",
	             success: function(data){
	            	 $("#problemEndUser").append('<option value="">请选择解决人</option>' );
	            	 if(data !== null){
	            		 for (var i = 0; i < data.length; i++) {
	            			 $("#problemEndUser").append('<option value="'+data[i].id+'">'+data[i].userName+'</option>' );
						 }
	            	 }
               }
     	 	});
		};
		
		/**
		 * 新增问题
		 */
		this.addProblemInfo = function(){
			 //验证成功，保存数据
	    	var saveData = $("#addProblem_Form").serialize();
	    	$.ajax({
      		  	type : 'post',
      		  	url : "ProblemController/addProblem.action",
      		  	data : saveData,
      		  	dataType : "json",
      		  	async : false,
      		  	success : function(data) {
      		  		if (data !== null && data === '0000') {
      		  			$("#addProblemModal").modal('hide');
      		  			$("#myModal").modal('show');
      		  			$("#modelInfo").text("问题新增成功！");
      		  		} else {
      		  			var error = data !== "" ? data : "新增失败，请联系管理员!";
      		  			$("#error").html(error);
      		  		}
      		  	}   
      	  	});
		};
		
		/**
		 * 提交任务，任务完成
		 */
		this.submitProblem = function(id){
			var saveData = {id: id, taskState: ""};
	    	$.ajax({
      		  	type : 'post',
      		  	url : "TaskInfoController/editTaskInfo.action",
      		  	data : saveData,
      		  	dataType : "json",
      		  	async : false,
      		  	success : function(data) {
      		  		if (data !== null && data === '0000') {
      		  			$("#submitModal").modal('hide');
      		  			$("#myModal").modal('show');
      		  			$("#modelInfo").text("任务提交成功，已进入审核状态！");
      		  			_this.getUserTask();//获取用户下的任务
      		  		} else {
      		  			$("#submitModal").modal('hide');
      		  			$("#myModal").modal('show');
      		  			var error = data !== "" ? data : "任务提交失败，请联系管理员!";
      		  			$("#modelInfo").text(error);
      		  		}
      		  	}   
      	  	});
		};
		
		/*
		 * 修改个人信息
		 */
		this.updateUserInfo = function(){
			
		};
		
		/*
		 * 跳转到项目日历
		 */
		this.targetProCalendar = function(){
			
		};
		
		/*
		 * 跳转到编辑页面
		 */
		this.targetActiviti = function(){
			
		};
		
		/*
		 * 获取任务详情
		 */
		this.getTaskDetail = function(){
			var id = document.getElementsByName("task");
			$.ajax({
	             type: "post",
	             url: "",
	             dataType: "json",
	             success: function(data){
	            	 
	             },
	             error: function(errorTwon){
	            	 
	             }
	        });
		};
	};
	
	return Myself;
},{
	requires : ['io','fullcalendar-module/src/calendar','common-module/src/cookie']
});